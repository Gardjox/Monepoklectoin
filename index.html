<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Gestionnaire de collection Pok√©mon">
    <meta name="theme-color" content="#9333ea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pok√©mon TCG">
    <link rel="manifest" href="manifest.json">
    <title>Ma Collection Pok√©mon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Support pour le notch iPhone */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        /* Am√©lioration du touch sur mobile */
        button, a, select, input {
            -webkit-tap-highlight-color: rgba(147, 51, 234, 0.2);
            touch-action: manipulation;
        }
        
        /* Emp√™cher le zoom sur double-tap iOS */
        * {
            touch-action: pan-y;
        }
        
        body.dark-mode { background: linear-gradient(to bottom right, #1a202c, #2d3748); }
        body.dark-mode .bg-white { background-color: #2d3748 !important; }
        body.dark-mode .text-gray-800 { color: #e2e8f0 !important; }
        body.dark-mode .text-gray-600 { color: #cbd5e0 !important; }
        body.dark-mode .text-gray-700 { color: #e2e8f0 !important; }
        body.dark-mode .text-gray-500 { color: #9ca3af !important; }
        body.dark-mode .text-black { color: #e2e8f0 !important; }
        body.dark-mode .border { border-color: #4a5568 !important; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { 
            background-color: #374151 !important; 
            color: #e2e8f0 !important; 
            border-color: #4a5568 !important; 
        }
        body.dark-mode input::placeholder, body.dark-mode textarea::placeholder { color: #9ca3af !important; }
        body.dark-mode table { background-color: #2d3748 !important; }
        body.dark-mode tbody tr { background-color: #374151 !important; }
        body.dark-mode tbody tr:nth-child(even) { background-color: #2d3748 !important; }
        body.dark-mode .bg-gray-50 { background-color: #374151 !important; }
        body.dark-mode .bg-gray-100 { background-color: #4a5568 !important; }
        body.dark-mode .bg-gray-200 { background-color: #4a5568 !important; }
        
        /* Bulles du r√©sum√© en mode sombre */
        body.dark-mode .bg-purple-50 { background-color: #553c9a !important; }
        body.dark-mode .bg-blue-50 { background-color: #1e3a8a !important; }
        body.dark-mode .bg-green-50 { background-color: #14532d !important; }
        body.dark-mode .bg-orange-50 { background-color: #7c2d12 !important; }
        body.dark-mode .bg-yellow-50 { background-color: #713f12 !important; }
        body.dark-mode .bg-red-50 { background-color: #7f1d1d !important; }
        
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { 
            display: none; 
            position: absolute; 
            background-color: white; 
            min-width: 200px; 
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2); 
            z-index: 1; 
            border-radius: 8px; 
            margin-top: 2px;
            padding: 4px 0;
        }
        body.dark-mode .dropdown-content { background-color: #2d3748; }
        .dropdown-content.show { 
            display: block; 
        }
        .dropdown-content button { 
            color: black; 
            padding: 12px 16px; 
            text-decoration: none; 
            display: block; 
            width: 100%; 
            text-align: left; 
            border: none; 
            background: none; 
            cursor: pointer;
            border-radius: 6px;
            margin: 2px 4px;
            width: calc(100% - 8px);
        }
        body.dark-mode .dropdown-content button { color: #e2e8f0; }
        .dropdown-content button:hover { 
            background-color: #e5e7eb;
        }
        body.dark-mode .dropdown-content button:hover { background-color: #4a5568; }
        
        /* Animations pour la page d'accueil */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        .fade-in-delay { animation: fadeIn 0.8s ease-out 0.3s backwards; }
        
        /* Optimisation mobile : tailles de touch minimum */
        @media (max-width: 768px) {
            button, a, select {
                min-height: 44px; /* Taille recommand√©e par Apple */
                min-width: 44px;
            }
            
            /* Navigation plus compacte sur mobile */
            .dropdown {
                width: 100%;
            }
            
            /* Tableaux scrollables sur mobile */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: #9333ea #e5e7eb;
            }
            
            .overflow-x-auto::-webkit-scrollbar {
                height: 8px;
            }
            
            .overflow-x-auto::-webkit-scrollbar-track {
                background: #e5e7eb;
                border-radius: 10px;
            }
            
            .overflow-x-auto::-webkit-scrollbar-thumb {
                background: #9333ea;
                border-radius: 10px;
            }
            
            body.dark-mode .overflow-x-auto::-webkit-scrollbar-track {
                background: #374151;
            }
            
            body.dark-mode .overflow-x-auto::-webkit-scrollbar-thumb {
                background: #9333ea;
            }
            
            /* Indicateur visuel de scroll sur mobile */
            @media (max-width: 768px) {
                .overflow-x-auto::after {
                    content: '‚Üí Swipe';
                    position: absolute;
                    right: 0;
                    top: 50%;
                    transform: translateY(-50%);
                    background: linear-gradient(to left, rgba(147, 51, 234, 0.9), transparent);
                    padding: 8px 16px;
                    border-radius: 20px 0 0 20px;
                    color: white;
                    font-size: 12px;
                    font-weight: bold;
                    pointer-events: none;
                    opacity: 0.8;
                    animation: pulse 2s infinite;
                }
                
                .overflow-x-auto.scrolled::after {
                    display: none;
                }
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 0.8; }
                50% { opacity: 0.4; }
            }
            
            /* S'assurer que les tableaux ont une largeur minimale */
            .overflow-x-auto table {
                min-width: 800px;
            }
            
            /* Espacements r√©duits sur mobile */
            body {
                padding: 1rem;
            }
        }
        
        /* Am√©lioration des inputs sur iOS */
        input, select, textarea {
            font-size: 16px; /* Emp√™che le zoom automatique sur iOS */
            border-radius: 8px;
        }
        
        /* Menu burger */
        .burger-menu {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 8px;
        }
        
        .burger-menu span {
            width: 28px;
            height: 3px;
            background-color: #7c3aed;
            margin: 3px 0;
            transition: 0.3s;
            border-radius: 2px;
        }
        
        body.dark-mode .burger-menu span {
            background-color: #e2e8f0;
        }
        
        .burger-menu.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-6px, 6px);
        }
        
        .burger-menu.active span:nth-child(2) {
            opacity: 0;
        }
        
        .burger-menu.active span:nth-child(3) {
            transform: rotate(45deg) translate(-6px, -6px);
        }
        
        .mobile-nav {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .mobile-nav.active {
            display: block;
        }
        
        .mobile-nav-content {
            position: absolute;
            top: 0;
            right: -100%;
            width: 80%;
            max-width: 320px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }
        
        body.dark-mode .mobile-nav-content {
            background: #2d3748;
        }
        
        .mobile-nav.active .mobile-nav-content {
            right: 0;
        }
        
        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        body.dark-mode .mobile-nav-header {
            border-bottom-color: #4a5568;
        }
        
        .mobile-nav-item {
            padding: 16px;
            margin: 8px 0;
            border-radius: 12px;
            background: #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            color: #374151;
        }
        
        body.dark-mode .mobile-nav-item {
            background: #374151;
            color: #e2e8f0;
        }
        
        .mobile-nav-item:active {
            transform: scale(0.98);
        }
        
        .mobile-nav-item:hover {
            background: #e5e7eb;
        }
        
        body.dark-mode .mobile-nav-item:hover {
            background: #4a5568;
        }
        
        .mobile-nav-submenu {
            margin-left: 16px;
            margin-top: 8px;
        }
        
        .mobile-nav-subitem {
            padding: 12px 16px;
            margin: 4px 0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
        }
        
        body.dark-mode .mobile-nav-subitem {
            background: #2d3748;
            color: #9ca3af;
        }
        
        @media (max-width: 768px) {
            .burger-menu {
                display: flex;
            }
            
            .desktop-nav {
                display: none !important;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-nav {
                display: none !important;
            }
        }
        
        /* Header fixe */
        .main-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(to right, #7c3aed, #3b82f6);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            padding-top: max(env(safe-area-inset-top), 12px);
        }
        
        body.dark-mode .main-header {
            background: linear-gradient(to right, #553c9a, #1e3a8a);
        }
        
        /* Menu burger plus accessible */
        @media (max-width: 768px) {
            .burger-menu {
                padding: 12px;
                margin: -12px;
                min-width: 48px;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
        
        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px 0 20px 0;
            border-bottom: 2px solid #e5e7eb;
        }
        
        body.dark-mode .mobile-nav-header {
            border-bottom-color: #4a5568;
        }
        
        .mobile-nav-close {
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f3f4f6;
            cursor: pointer;
            font-size: 28px;
            line-height: 1;
            padding: 0;
            border: none;
        }
        
        body.dark-mode .mobile-nav-close {
            background: #4a5568;
            color: #e2e8f0;
        }
        
        .mobile-nav-close:active {
            transform: scale(0.95);
        }
        
        /* Footer fixe */
        .main-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: white;
            border-top: 2px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            padding: env(safe-area-inset-bottom) 0 0 0;
        }
        
        body.dark-mode .main-footer {
            background: #2d3748;
            border-top-color: #4a5568;
        }
        
        /* Espace pour le footer */
        .main-content {
            padding-bottom: 80px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding-bottom: 70px;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50">
    
    <!-- Header fixe -->
    <header class="main-header">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-lg md:text-2xl font-bold text-white cursor-pointer hover:opacity-80 transition" onclick="showTab('home')">
                    üé¥ Ma Collection Pok√©mon
                </h1>
                
                <!-- Menu burger (mobile uniquement) -->
                <div class="burger-menu" onclick="toggleMobileNav()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto main-content p-4 md:p-6">

        <!-- Navigation Desktop -->
        <div class="desktop-nav flex gap-2 md:gap-4 mb-4 md:mb-6 items-center flex-wrap justify-center">
            <button onclick="showTab('home')" class="px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold transition bg-white text-gray-700 hover:bg-gray-100 text-sm md:text-base">
                üè† Accueil
            </button>
            
            <div class="dropdown">
                <button onclick="toggleDropdown('collection-menu')" class="px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold transition bg-white text-gray-700 hover:bg-gray-100 text-sm md:text-base">
                    üì¶ Collection ‚ñº
                </button>
                <div id="collection-menu" class="dropdown-content">
                    <button onclick="showTab('add-collection')">‚ûï Ajout produit collection</button>
                    <button onclick="showTab('my-collection')">üìã Ma collection</button>
                </div>
            </div>
            
            <div class="dropdown">
                <button onclick="toggleDropdown('vente-menu')" class="px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold transition bg-white text-gray-700 hover:bg-gray-100 text-sm md:text-base">
                    üí∞ Vente ‚ñº
                </button>
                <div id="vente-menu" class="dropdown-content">
                    <button onclick="showTab('add-sale')">‚ûï Ajouter une carte</button>
                    <button onclick="showTab('sale-list')">üìã Liste des produits</button>
                    <button onclick="showTab('dashboard')">üìä Tableau de bord</button>
                </div>
            </div>

            <div class="dropdown">
                <button onclick="toggleDropdown('stock-menu')" class="px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold transition bg-white text-gray-700 hover:bg-gray-100 text-sm md:text-base">
                    üì¶ Stock ‚ñº
                </button>
                <div id="stock-menu" class="dropdown-content">
                    <button onclick="showTab('stock-add')">‚ûï Renseignement</button>
                    <button onclick="showTab('stock-list')">üìã Liste du stock</button>
                    <button onclick="showTab('stock-lots')">üì¶ Liste des lots</button>
                </div>
            </div>

            <button onclick="showTab('card-search')" class="px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold transition bg-white text-gray-700 hover:bg-gray-100 text-sm md:text-base">
                üîç Recherche
            </button>
        </div>

        <!-- Navigation Mobile (menu burger) -->
        <div id="mobile-nav" class="mobile-nav" onclick="closeMobileNavOnOverlay(event)">
            <div class="mobile-nav-content" onclick="event.stopPropagation()">
                <div class="mobile-nav-header">
                    <h2 class="text-xl font-bold text-purple-900">Menu</h2>
                    <button onclick="toggleMobileNav()" class="mobile-nav-close">√ó</button>
                </div>
                
                <div onclick="navigateMobile('home')" class="mobile-nav-item">
                    üè† Accueil
                </div>
                
                <div class="mobile-nav-item">
                    üì¶ Collection
                    <div class="mobile-nav-submenu">
                        <div onclick="navigateMobile('add-collection')" class="mobile-nav-subitem">
                            ‚ûï Ajout produit collection
                        </div>
                        <div onclick="navigateMobile('my-collection')" class="mobile-nav-subitem">
                            üìã Ma collection
                        </div>
                    </div>
                </div>
                
                <div class="mobile-nav-item">
                    üí∞ Vente
                    <div class="mobile-nav-submenu">
                        <div onclick="navigateMobile('add-sale')" class="mobile-nav-subitem">
                            ‚ûï Ajouter une carte
                        </div>
                        <div onclick="navigateMobile('sale-list')" class="mobile-nav-subitem">
                            üìã Liste des produits
                        </div>
                        <div onclick="navigateMobile('dashboard')" class="mobile-nav-subitem">
                            üìä Tableau de bord
                        </div>
                    </div>
                </div>
                
                <div class="mobile-nav-item">
                    üì¶ Stock
                    <div class="mobile-nav-submenu">
                        <div onclick="navigateMobile('stock-add')" class="mobile-nav-subitem">
                            ‚ûï Renseignement
                        </div>
                        <div onclick="navigateMobile('stock-list')" class="mobile-nav-subitem">
                            üìã Liste du stock
                        </div>
                        <div onclick="navigateMobile('stock-lots')" class="mobile-nav-subitem">
                            üì¶ Liste des lots
                        </div>
                    </div>
                </div>
                
                <div onclick="navigateMobile('card-search')" class="mobile-nav-item">
                    üîç Recherche de cartes
                </div>
            </div>
        </div>

        <!-- Bouton d'installation PWA (cach√© par d√©faut) -->
        <button id="install-btn" style="display: none;" class="fixed bottom-6 right-6 bg-purple-600 text-white px-6 py-3 rounded-full shadow-lg hover:bg-purple-700 font-semibold flex items-center gap-2 z-50">
            üì± Installer l'application
        </button>

        <!-- Bouton Mode Sombre -->
        <button id="dark-mode-toggle" onclick="toggleDarkMode()" class="fixed bottom-6 left-6 bg-gray-800 text-white px-4 py-3 rounded-full shadow-lg hover:bg-gray-700 font-semibold z-50" title="Basculer mode sombre">
            üåô
        </button>

        <!-- ONGLET: Page d'accueil -->
        <div id="content-home">
            <div class="space-y-8">
                <!-- Hero Section -->
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl shadow-2xl p-8 md:p-12 text-white fade-in">
                    <div class="text-center">
                        <h2 class="text-5xl md:text-6xl font-bold mb-4">‚ú® Bienvenue Dresseur ! ‚ú®</h2>
                        <p class="text-xl md:text-2xl mb-6 opacity-90">Ta collection Pok√©mon n'attend que toi</p>
                        <div class="flex justify-center gap-4 flex-wrap">
                            <button onclick="showTab('add-collection')" class="bg-white text-purple-600 px-8 py-3 rounded-lg font-bold hover:bg-gray-100 transition transform hover:scale-105">
                                üé¥ Commencer ma collection
                            </button>
                            <button onclick="showTab('card-search')" class="bg-purple-800 text-white px-8 py-3 rounded-lg font-bold hover:bg-purple-900 transition transform hover:scale-105">
                                üîç Rechercher des cartes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pourquoi collectionner ? -->
                <div class="grid md:grid-cols-2 gap-6 fade-in-delay">
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                        <div class="text-4xl mb-4 text-center">üéØ</div>
                        <h3 class="text-2xl font-bold mb-3 text-purple-900 text-center">Passion & Nostalgie</h3>
                        <p class="text-gray-700 leading-relaxed">
                            Depuis 1996, Pok√©mon TCG captive des millions de collectionneurs √† travers le monde. Chaque carte raconte une histoire, 
                            rappelle des souvenirs d'enfance et cr√©e de nouvelles aventures. Que tu recherches un Dracaufeu brillant ou que tu compl√®tes 
                            une extension enti√®re, chaque d√©couverte est une victoire !
                        </p>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                        <div class="text-4xl mb-4 text-center">üíé</div>
                        <h3 class="text-2xl font-bold mb-3 text-blue-900 text-center">Valeur & Investissement</h3>
                        <p class="text-gray-700 leading-relaxed">
                            Les cartes Pok√©mon ne sont pas qu'un passe-temps, c'est aussi un investissement intelligent. Certaines cartes rares 
                            prennent √©norm√©ment de valeur avec le temps. Avec cette application, suis l'√©volution de ta collection, compare les prix 
                            d'achat et de revente, et d√©couvre tes meilleures p√©pites !
                        </p>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                        <div class="text-4xl mb-4 text-center">üìä</div>
                        <h3 class="text-2xl font-bold mb-3 text-green-900 text-center">Organisation Parfaite</h3>
                        <p class="text-gray-700 leading-relaxed">
                            Fini les classeurs d√©sorganis√©s ! G√®re ta collection avec pr√©cision : ajoute des photos, note l'√©tat de chaque carte, 
                            organise par extension (EV, EB, SL...), cr√©e des lots, et suis ton stock en temps r√©el. Tout est √† port√©e de main, 
                            sur ton t√©l√©phone ou ordinateur.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                        <div class="text-4xl mb-4 text-center">üöÄ</div>
                        <h3 class="text-2xl font-bold mb-3 text-orange-900 text-center">Fonctionnalit√©s Puissantes</h3>
                        <p class="text-gray-700 leading-relaxed">
                            Recherche de cartes via API officielle, mode sombre pour les yeux sensibles, export/import de donn√©es, 
                            gestion de ventes, tableaux de bord statistiques, syst√®me de lots pour achats group√©s... Cette app a tout ce qu'il faut 
                            pour les collectionneurs s√©rieux !
                        </p>
                    </div>
                </div>

                <!-- Call to action -->
                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl shadow-2xl p-8 text-center fade-in-delay">
                    <h3 class="text-3xl font-bold mb-4 text-white">üéâ Pr√™t √† devenir le meilleur collectionneur ? üéâ</h3>
                    <p class="text-xl text-white mb-6 opacity-90">
                        Rejoins l'aventure et transforme ta passion en collection organis√©e et valoris√©e !
                    </p>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <button onclick="showTab('stock-add')" class="bg-white text-orange-600 px-8 py-3 rounded-lg font-bold hover:bg-gray-100 transition transform hover:scale-105">
                            üì¶ G√©rer mon stock
                        </button>
                        <button onclick="showTab('stock-lots')" class="bg-orange-700 text-white px-8 py-3 rounded-lg font-bold hover:bg-orange-800 transition transform hover:scale-105">
                            üéÅ Cr√©er des lots
                        </button>
                    </div>
                </div>

                <!-- Fun facts -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-4 text-purple-900 text-center">üí° Le savais-tu ?</h3>
                    <div class="grid md:grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-purple-50 rounded-lg">
                            <div class="text-3xl mb-2">üèÜ</div>
                            <p class="font-semibold text-purple-900">Une carte Pikachu Illustrator</p>
                            <p class="text-sm text-gray-600">s'est vendue 5,3 millions de dollars en 2021 !</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <div class="text-3xl mb-2">üåç</div>
                            <p class="font-semibold text-blue-900">Plus de 43 milliards</p>
                            <p class="text-sm text-gray-600">de cartes Pok√©mon ont √©t√© produites dans le monde</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg">
                            <div class="text-3xl mb-2">üìÖ</div>
                            <p class="font-semibold text-green-900">28 ans d'histoire</p>
                            <p class="text-sm text-gray-600">depuis le lancement du TCG en octobre 1996</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ONGLET: Stock - Renseignement -->
        <div id="content-stock-add" style="display: none;">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Ajouter au stock</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="stock-objet" class="border rounded px-3 py-2">
                        <option value="Carte">Carte</option>
                        <option value="Carte grad√©e">Carte grad√©e</option>
                        <option value="Scell√©">Scell√©</option>
                        <option value="Autre">Autre</option>
                    </select>
                    
                    <div class="border rounded px-3 py-2 flex items-center gap-2">
                        <label class="cursor-pointer text-gray-600 hover:text-purple-600 flex items-center gap-2">
                            üì∑ Photo
                            <input type="file" id="stock-photo" accept=".jpg,.jpeg,.png,.webp" class="hidden" onchange="handleStockPhoto(event)">
                        </label>
                        <span id="stock-photo-status"></span>
                    </div>

                    <select id="stock-collection" class="border rounded px-3 py-2">
                        <option value="EV">EV - √âcarlate et Violet</option>
                        <option value="EB">EB - √âp√©e et Bouclier</option>
                        <option value="SL">SL - Soleil et Lune</option>
                        <option value="XY">XY</option>
                        <option value="NB">NB - Noir et Blanc</option>
                        <option value="DP">DP - Diamant et Perle</option>
                        <option value="EX">EX</option>
                        <option value="WIZARD">WIZARD</option>
                    </select>

                    <input type="datetime-local" id="stock-date" class="border rounded px-3 py-2">

                    <select id="stock-etat" class="border rounded px-3 py-2">
                        <option value="Neuf">Neuf</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Bon">Bon</option>
                        <option value="Moyen">Moyen</option>
                        <option value="Ab√Æm√©">Ab√Æm√©</option>
                    </select>

                    <input type="text" id="stock-details-etat" placeholder="D√©tails de l'√©tat" class="border rounded px-3 py-2">

                    <select id="stock-achat-lieu" class="border rounded px-3 py-2">
                        <option value="Boutique">Boutique</option>
                        <option value="Vinted">Site - Vinted</option>
                        <option value="Ebay">Site - Ebay</option>
                        <option value="Cardmarket">Site - Cardmarket</option>
                        <option value="Ench√®re">Ench√®re</option>
                        <option value="Autre">Autre</option>
                    </select>

                    <input type="number" id="stock-prix-achat" step="0.01" placeholder="Prix d'achat (‚Ç¨)" class="border rounded px-3 py-2">

                    <input type="number" id="stock-prix-revente" step="0.01" placeholder="Prix de revente voulu (‚Ç¨)" class="border rounded px-3 py-2">

                    <select id="stock-etat-actuel" class="border rounded px-3 py-2">
                        <option value="Stock">Stock</option>
                        <option value="En vente">En vente</option>
                        <option value="Vendu">Vendu</option>
                    </select>

                    <select id="stock-lot" class="border rounded px-3 py-2">
                        <option value="">Aucun lot</option>
                        <!-- Les lots seront ajout√©s dynamiquement -->
                    </select>

                    <input type="text" id="stock-details" placeholder="D√©tails (commentaire)" class="border rounded px-3 py-2 md:col-span-3">
                </div>
                <button onclick="addStockItem()" class="mt-4 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                    <span id="stock-submit-btn-text">‚ûï Ajouter au stock</span>
                </button>
                <button onclick="cancelStockEdit()" id="stock-cancel-btn" style="display: none;" class="mt-4 ml-2 bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                    ‚ùå Annuler
                </button>
            </div>
            <div id="stock-photo-preview" class="bg-white rounded-lg shadow-lg p-4" style="display: none;">
                <h3 class="text-lg font-semibold mb-2">Aper√ßu photo</h3>
                <img id="stock-photo-img" class="max-w-xs rounded cursor-pointer" onclick="zoomStockPhoto()" alt="Photo stock">
            </div>
        </div>

        <!-- ONGLET: Stock - Liste -->
        <div id="content-stock-list" style="display: none;">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <input type="text" id="stock-search" placeholder="üîç Rechercher dans le stock..." class="border rounded px-10 py-2 w-full" oninput="filterStockItems()">
            </div>

            <!-- Tableau: En Stock -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
                <div class="bg-blue-600 text-white px-4 py-2 font-semibold">üì¶ En stock</div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-blue-100">
                            <tr>
                                <th class="px-4 py-3 text-left">Photo</th>
                                <th class="px-4 py-3 text-left">Objet</th>
                                <th class="px-4 py-3 text-left">Collection</th>
                                <th class="px-4 py-3 text-left">Date achat</th>
                                <th class="px-4 py-3 text-left">√âtat</th>
                                <th class="px-4 py-3 text-left">O√π achet√©</th>
                                <th class="px-4 py-3 text-left">Lot</th>
                                <th class="px-4 py-3 text-left">Prix achat</th>
                                <th class="px-4 py-3 text-left">Prix revente</th>
                                <th class="px-4 py-3 text-left">+/- Value</th>
                                <th class="px-4 py-3 text-left">Statut</th>
                                <th class="px-4 py-3 text-left">D√©tails</th>
                                <th class="px-4 py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-stock"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tableau: En Vente -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
                <div class="bg-orange-600 text-white px-4 py-2 font-semibold">üî• En vente</div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-orange-100">
                            <tr>
                                <th class="px-4 py-3 text-left">Photo</th>
                                <th class="px-4 py-3 text-left">Objet</th>
                                <th class="px-4 py-3 text-left">Collection</th>
                                <th class="px-4 py-3 text-left">Date achat</th>
                                <th class="px-4 py-3 text-left">√âtat</th>
                                <th class="px-4 py-3 text-left">O√π achet√©</th>
                                <th class="px-4 py-3 text-left">Lot</th>
                                <th class="px-4 py-3 text-left">Prix achat</th>
                                <th class="px-4 py-3 text-left">Prix revente</th>
                                <th class="px-4 py-3 text-left">+/- Value</th>
                                <th class="px-4 py-3 text-left">Statut</th>
                                <th class="px-4 py-3 text-left">D√©tails</th>
                                <th class="px-4 py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-vente"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tableau: Vendus -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-green-600 text-white px-4 py-2 font-semibold">‚úÖ Vendus</div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-green-100">
                            <tr>
                                <th class="px-4 py-3 text-left">Photo</th>
                                <th class="px-4 py-3 text-left">Objet</th>
                                <th class="px-4 py-3 text-left">Collection</th>
                                <th class="px-4 py-3 text-left">Date achat</th>
                                <th class="px-4 py-3 text-left">√âtat</th>
                                <th class="px-4 py-3 text-left">O√π achet√©</th>
                                <th class="px-4 py-3 text-left">Lot</th>
                                <th class="px-4 py-3 text-left">Prix achat</th>
                                <th class="px-4 py-3 text-left">Prix revente</th>
                                <th class="px-4 py-3 text-left">+/- Value</th>
                                <th class="px-4 py-3 text-left">Statut</th>
                                <th class="px-4 py-3 text-left">D√©tails</th>
                                <th class="px-4 py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-vendu"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ONGLET: Stock - Liste des lots -->
        <div id="content-stock-lots" style="display: none;">
            <div class="mb-6">
                <button onclick="openCreateLotModal()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold">
                    ‚ûï Cr√©er un lot
                </button>
            </div>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-purple-600 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left">Photo</th>
                                <th class="px-4 py-3 text-left">Nom du lot</th>
                                <th class="px-4 py-3 text-left">Date et heure</th>
                                <th class="px-4 py-3 text-left">Prix d'achat</th>
                                <th class="px-4 py-3 text-left">Nb cartes</th>
                                <th class="px-4 py-3 text-left">D√©tails</th>
                                <th class="px-4 py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="lots-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modal Zoom Photo -->
        <div id="photo-zoom-modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="closePhotoZoom()">
            <img id="photo-zoom-img" class="max-w-5xl max-h-screen rounded" alt="Photo zoom√©e">
        </div>

        <!-- Modal Cr√©er un lot -->
        <div id="create-lot-modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="closeCreateLotModal(event)">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Cr√©er un lot</h2>
                    <button onclick="closeCreateLotModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="lot-nom" placeholder="Nom du lot" class="border rounded px-3 py-2">
                    <input type="datetime-local" id="lot-date" class="border rounded px-3 py-2">
                    <input type="number" id="lot-prix" step="0.01" placeholder="Prix d'achat du lot (‚Ç¨)" class="border rounded px-3 py-2">
                    <input type="number" id="lot-nb-cartes" placeholder="Nombre de cartes" class="border rounded px-3 py-2">
                    <div class="border rounded px-3 py-2 flex items-center gap-2 md:col-span-2">
                        <label class="cursor-pointer text-gray-600 hover:text-purple-600 flex items-center gap-2">
                            üì∑ Photo (optionnel)
                            <input type="file" id="lot-photo" accept=".jpg,.jpeg,.png,.webp" class="hidden" onchange="handleLotPhoto(event)">
                        </label>
                        <span id="lot-photo-status"></span>
                    </div>
                    <textarea id="lot-details" placeholder="D√©tails (d√©fauts, commentaires...)" class="border rounded px-3 py-2 md:col-span-2" rows="3"></textarea>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button onclick="createLot()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                        ‚ûï Cr√©er le lot
                    </button>
                    <button onclick="closeCreateLotModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                        Annuler
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Modifier le lot (ajouter des cartes) -->
        <div id="modify-lot-modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="closeModifyLotModal(event)">
            <div class="bg-white rounded-lg p-6 max-w-5xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold" id="modify-lot-title">Modifier le lot</h2>
                    <button onclick="closeModifyLotModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>
                
                <!-- Bouton ajouter une carte -->
                <div class="mb-6">
                    <button onclick="openAddCardToLotModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                        ‚ûï Ajouter une carte au lot
                    </button>
                </div>

                <!-- Liste des cartes du lot -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3">Cartes dans ce lot</h3>
                    <div id="lot-cards-list" class="space-y-3">
                        <!-- Les cartes s'afficheront ici -->
                    </div>
                </div>

                <div class="flex gap-2 mt-6">
                    <button onclick="closeModifyLotModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                        Fermer
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Ajouter une carte au lot -->
        <div id="add-card-lot-modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="closeAddCardToLotModal(event)">
            <div class="bg-white rounded-lg p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Ajouter une carte au lot</h2>
                    <button onclick="closeAddCardToLotModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border rounded px-3 py-2 flex items-center gap-2 md:col-span-2">
                        <label class="cursor-pointer text-gray-600 hover:text-purple-600 flex items-center gap-2">
                            üì∑ Photo de la carte
                            <input type="file" id="card-lot-photo" accept=".jpg,.jpeg,.png,.webp" class="hidden" onchange="handleCardLotPhoto(event)">
                        </label>
                        <span id="card-lot-photo-status"></span>
                    </div>
                    
                    <input type="text" id="card-lot-nom" placeholder="Nom de la carte" class="border rounded px-3 py-2 md:col-span-2">
                    
                    <select id="card-lot-type" class="border rounded px-3 py-2">
                        <option value="Basique">Basique</option>
                        <option value="Reverse">Reverse</option>
                        <option value="Holo">Holo</option>
                        <option value="Holo Reverse">Holo Reverse</option>
                    </select>
                    
                    <input type="number" id="card-lot-quantite" min="1" value="1" placeholder="Quantit√©" class="border rounded px-3 py-2">
                    
                    <select id="card-lot-qualite" class="border rounded px-3 py-2">
                        <option value="Mint">Mint</option>
                        <option value="Near Mint">Near Mint</option>
                        <option value="Excellent +">Excellent +</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Tr√®s bon">Tr√®s bon</option>
                        <option value="Bon">Bon</option>
                        <option value="Played">Played</option>
                        <option value="Mauvais">Mauvais</option>
                    </select>
                    
                    <input type="number" id="card-lot-prix-achat" step="0.01" placeholder="Prix d'achat potentiel (calcul√© auto)" class="border rounded px-3 py-2 bg-gray-100" readonly>
                    
                    <input type="number" id="card-lot-prix-revente" step="0.01" placeholder="Prix de revente potentiel (‚Ç¨)" class="border rounded px-3 py-2 md:col-span-2">
                    
                    <textarea id="card-lot-description-etat" placeholder="Description de l'√©tat de la carte (rayures, d√©fauts...)" class="border rounded px-3 py-2 md:col-span-2" rows="3"></textarea>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button onclick="addCardToLot()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                        ‚ûï Ajouter
                    </button>
                    <button onclick="closeAddCardToLotModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                        Annuler
                    </button>
                </div>
            </div>
        </div>

        <!-- ONGLET: Recherche de cartes (API) -->
        <div id="content-card-search" style="display: none;">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üîç Recherche de cartes Pok√©mon</h2>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="api-search" placeholder="Rechercher une carte (ex: Dracaufeu, Pikachu...)" class="border rounded px-4 py-2 flex-1">
                    <select id="result-limit" class="border rounded px-4 py-2">
                        <option value="10">10 r√©sultats</option>
                        <option value="25" selected>25 r√©sultats</option>
                        <option value="50">50 r√©sultats</option>
                        <option value="100">100 r√©sultats</option>
                        <option value="250">Tous (250 max)</option>
                    </select>
                    <button onclick="searchCards()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 font-semibold">
                        Rechercher
                    </button>
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    üí° Astuce : Recherchez en fran√ßais ! (Dracaufeu, Tortank, Pikachu...)
                </div>
            </div>

            <div id="search-info" class="mb-4 text-center text-gray-600" style="display: none;"></div>

            <div id="search-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Les r√©sultats s'afficheront ici -->
            </div>

            <div id="search-loading" style="display: none;" class="text-center py-8">
                <div class="text-2xl mb-2">‚è≥ Recherche en cours...</div>
                <div class="text-sm text-gray-500">R√©cup√©ration des cartes...</div>
            </div>
        </div>

        <!-- ONGLET: Ajout produit collection -->
        <div id="content-add-collection">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Ajouter un produit √† la collection</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="collection" class="border rounded px-3 py-2">
                        <option value="Carte √† l'unit√©">Carte √† l'unit√©</option>
                        <option value="Carte grad√©e">Carte grad√©e</option>
                        <option value="Booster">Booster</option>
                        <option value="Bundle">Bundle</option>
                        <option value="Tripack">Tripack</option>
                        <option value="Duopack">Duopack</option>
                        <option value="ETB">ETB</option>
                        <option value="SPC">SPC</option>
                        <option value="Autre">Autre</option>
                    </select>
                    <select id="ere" class="border rounded px-3 py-2">
                        <option value="EV">EV</option>
                        <option value="EB">EB</option>
                        <option value="SL">SL</option>
                        <option value="XY">XY</option>
                        <option value="NB">NB</option>
                        <option value="DP">DP</option>
                        <option value="EX">EX</option>
                        <option value="WIZARD">WIZARD</option>
                    </select>
                    <input type="text" id="nom" placeholder="Nom du produit" class="border rounded px-3 py-2">
                    <input type="number" id="prix" step="0.01" placeholder="Prix d'achat (‚Ç¨)" class="border rounded px-3 py-2">
                    <input type="number" id="prix-revente" step="0.01" placeholder="Prix de revente (‚Ç¨)" class="border rounded px-3 py-2">
                    <select id="etat" class="border rounded px-3 py-2">
                        <option value="Neuf">Neuf</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Bon">Bon</option>
                        <option value="Moyen">Moyen</option>
                        <option value="Ab√Æm√©">Ab√Æm√©</option>
                    </select>
                    <input type="text" id="lieu" placeholder="Lieu d'achat" class="border rounded px-3 py-2">
                    <input type="text" id="details" placeholder="D√©tails/Commentaires" class="border rounded px-3 py-2">
                    <div class="border rounded px-3 py-2 flex items-center gap-2">
                        <label class="cursor-pointer text-gray-600 hover:text-purple-600 flex items-center gap-2">
                            üì∑ Image
                            <input type="file" id="image" accept=".jpg,.jpeg,.png,.webp" class="hidden" onchange="handleImage(event)">
                        </label>
                        <span id="image-status"></span>
                    </div>
                </div>
                <button onclick="addProduct()" class="mt-4 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                    <span id="submit-btn-text">‚ûï Ajouter</span>
                </button>
                <button onclick="cancelEdit()" id="cancel-btn" style="display: none;" class="mt-4 ml-2 bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                    ‚ùå Annuler
                </button>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üìä R√©sum√©</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">Total produits</p>
                        <p id="total-products" class="text-3xl font-bold text-purple-700">0</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">Valeur achat</p>
                        <p id="total-value" class="text-3xl font-bold text-blue-700">0.00‚Ç¨</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">Valeur revente</p>
                        <p id="total-resale" class="text-3xl font-bold text-green-700">0.00‚Ç¨</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">+/- Value globale</p>
                        <p id="global-percentage" class="text-3xl font-bold text-gray-700">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ONGLET: Ma collection -->
        <div id="content-my-collection" style="display: none;">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Filtres</h2>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                            üì• Exporter
                        </button>
                        <label class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold cursor-pointer">
                            üì§ Importer
                            <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
                        </label>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="relative">
                        <input type="text" id="search" placeholder="üîç Rechercher..." class="border rounded px-10 py-2 w-full" oninput="filterProducts()">
                    </div>
                    <select id="filter-collection" class="border rounded px-3 py-2" onchange="filterProducts()">
                        <option value="">Tous les types</option>
                        <option value="Carte √† l'unit√©">Carte √† l'unit√©</option>
                        <option value="Carte grad√©e">Carte grad√©e</option>
                        <option value="Booster">Booster</option>
                        <option value="Bundle">Bundle</option>
                        <option value="Tripack">Tripack</option>
                        <option value="Duopack">Duopack</option>
                        <option value="ETB">ETB</option>
                        <option value="SPC">SPC</option>
                        <option value="Autre">Autre</option>
                    </select>
                    <select id="filter-ere" class="border rounded px-3 py-2" onchange="filterProducts()">
                        <option value="">Toutes les √®res</option>
                        <option value="EV">EV</option>
                        <option value="EB">EB</option>
                        <option value="SL">SL</option>
                        <option value="XY">XY</option>
                        <option value="NB">NB</option>
                        <option value="DP">DP</option>
                        <option value="EX">EX</option>
                        <option value="WIZARD">WIZARD</option>
                    </select>
                    <select id="filter-etat" class="border rounded px-3 py-2" onchange="filterProducts()">
                        <option value="">Tous les √©tats</option>
                        <option value="Neuf">Neuf</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Bon">Bon</option>
                        <option value="Moyen">Moyen</option>
                        <option value="Ab√Æm√©">Ab√Æm√©</option>
                    </select>
                    <select id="sort" class="border rounded px-3 py-2" onchange="filterProducts()">
                        <option value="">Trier par...</option>
                        <option value="nom">Nom A-Z</option>
                        <option value="collection">Collection A-Z</option>
                        <option value="prix-asc">Prix croissant</option>
                        <option value="prix-desc">Prix d√©croissant</option>
                    </select>
                </div>
                <div class="mt-4 text-lg font-semibold text-purple-800" id="filter-summary">
                    0 produit(s) ‚Ä¢ Valeur totale: 0.00‚Ç¨
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="text-sm text-gray-600 px-4 py-2 bg-gray-100 md:hidden">
                    üí° Faites glisser le tableau horizontalement pour voir toutes les colonnes ‚Üí
                </div>
                <div class="overflow-x-auto relative" onscroll="handleTableScroll(event)">
                    <table class="w-full">
                        <thead class="bg-purple-600 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left sticky left-0 bg-purple-600 z-10">Image</th>
                                <th class="px-4 py-3 text-left">Type</th>
                                <th class="px-4 py-3 text-left">√àre</th>
                                <th class="px-4 py-3 text-left">Nom</th>
                                <th class="px-4 py-3 text-left">Prix achat</th>
                                <th class="px-4 py-3 text-left">Prix revente</th>
                                <th class="px-4 py-3 text-left">+/- Value</th>
                                <th class="px-4 py-3 text-left">√âtat</th>
                                <th class="px-4 py-3 text-left">Lieu d'achat</th>
                                <th class="px-4 py-3 text-left">D√©tails</th>
                                <th class="px-4 py-3 text-center sticky right-0 bg-purple-600 z-10">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ONGLET: Ajouter une carte (Vente) -->
        <div id="content-add-sale" style="display: none;">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Ajouter une carte √† vendre</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="sale-nom" placeholder="Nom de la carte" class="border rounded px-3 py-2">
                    <select id="sale-etat" class="border rounded px-3 py-2">
                        <option value="Neuf">Neuf</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Bon">Bon</option>
                        <option value="Moyen">Moyen</option>
                        <option value="Ab√Æm√©">Ab√Æm√©</option>
                    </select>
                    <input type="number" id="sale-prix-achat" step="0.01" placeholder="Prix d'achat (‚Ç¨)" class="border rounded px-3 py-2">
                    <select id="sale-statut" class="border rounded px-3 py-2">
                        <option value="En vente">En vente</option>
                        <option value="Vendu">Vendu</option>
                        <option value="Pas list√©">Pas list√©</option>
                    </select>
                    <input type="number" id="sale-prix-potentiel" step="0.01" placeholder="Prix potentiel de revente (‚Ç¨)" class="border rounded px-3 py-2">
                    <input type="number" id="sale-prix-revente" step="0.01" placeholder="Prix de revente (‚Ç¨)" class="border rounded px-3 py-2">
                    <input type="text" id="sale-details" placeholder="D√©tails" class="border rounded px-3 py-2 md:col-span-3">
                    <div class="border rounded px-3 py-2 flex items-center gap-2 md:col-span-3">
                        <label class="cursor-pointer text-gray-600 hover:text-purple-600 flex items-center gap-2">
                            üì∑ Images (max 4)
                            <input type="file" id="sale-images" accept=".jpg,.jpeg,.png,.webp" multiple class="hidden" onchange="handleSaleImages(event)">
                        </label>
                        <span id="sale-images-status"></span>
                    </div>
                    <div id="sale-images-preview" class="md:col-span-3 flex gap-2 flex-wrap"></div>
                </div>
                <button onclick="addSaleProduct()" class="mt-4 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                    <span id="sale-submit-btn-text">‚ûï Ajouter</span>
                </button>
                <button onclick="cancelSaleEdit()" id="sale-cancel-btn" style="display: none;" class="mt-4 ml-2 bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                    ‚ùå Annuler
                </button>
            </div>
        </div>

        <!-- ONGLET: Liste des produits (Vente) -->
        <div id="content-sale-list" style="display: none;">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <input type="text" id="sale-search" placeholder="üîç Rechercher..." class="border rounded px-10 py-2 w-full" oninput="filterSaleProducts()">
            </div>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-purple-600 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left">Images</th>
                                <th class="px-4 py-3 text-left">Nom</th>
                                <th class="px-4 py-3 text-left">√âtat</th>
                                <th class="px-4 py-3 text-left">Prix achat</th>
                                <th class="px-4 py-3 text-left">Prix potentiel</th>
                                <th class="px-4 py-3 text-left">Prix revente</th>
                                <th class="px-4 py-3 text-left">Statut</th>
                                <th class="px-4 py-3 text-left">D√©tails</th>
                                <th class="px-4 py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sale-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ONGLET: Tableau de bord (Vente) -->
        <div id="content-dashboard" style="display: none;">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üìä R√©sum√© des ventes</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">Produits vendus</p>
                        <p id="sold-count" class="text-3xl font-bold text-green-700">0</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">Revenus totaux</p>
                        <p id="total-revenue" class="text-3xl font-bold text-blue-700">0.00‚Ç¨</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-sm">B√©n√©fice net</p>
                        <p id="net-profit" class="text-3xl font-bold text-purple-700">0.00‚Ç¨</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üìà Ventes par mois</h2>
                <canvas id="salesChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
    </div>

    <script>
        let products = loadProducts();
        let saleProducts = loadSaleProducts();
        let stockItems = loadStockItems();
        let lots = loadLots();
        let currentImage = null;
        let currentSaleImages = [];
        let currentStockPhoto = null;
        let currentLotPhoto = null;
        let currentCardLotPhoto = null;
        let currentEditingLotId = null;
        let editingProductId = null;
        let editingSaleId = null;
        let editingStockId = null;
        let salesChart = null;

        const collectionColors = {
            "Carte √† l'unit√©": 'text-black',
            "Carte grad√©e": 'text-red-600',
            "Booster": 'text-green-600',
            "Bundle": 'text-blue-600',
            "ETB": 'text-purple-600',
            "Tripack": 'text-yellow-600',
            "Duopack": 'text-yellow-600',
            "SPC": 'text-amber-700',
            "Autre": 'text-gray-500'
        };

        function toggleDropdown(menuId) {
            const menu = document.getElementById(menuId);
            const allMenus = document.querySelectorAll('.dropdown-content');
            
            allMenus.forEach(m => {
                if (m.id !== menuId) {
                    m.classList.remove('show');
                }
            });
            
            menu.classList.toggle('show');
        }

        window.onclick = function(event) {
            if (!event.target.closest('.dropdown')) {
                const allMenus = document.querySelectorAll('.dropdown-content');
                allMenus.forEach(m => m.classList.remove('show'));
            }
        }

        function saveProducts() {
            localStorage.setItem('pokemonCollection', JSON.stringify(products));
        }

        function loadProducts() {
            const saved = localStorage.getItem('pokemonCollection');
            return saved ? JSON.parse(saved) : [];
        }

        function saveSaleProducts() {
            localStorage.setItem('pokemonSales', JSON.stringify(saleProducts));
        }

        function loadSaleProducts() {
            const saved = localStorage.getItem('pokemonSales');
            return saved ? JSON.parse(saved) : [];
        }

        function saveStockItems() {
            localStorage.setItem('pokemonStock', JSON.stringify(stockItems));
        }

        function loadStockItems() {
            const saved = localStorage.getItem('pokemonStock');
            return saved ? JSON.parse(saved) : [];
        }

        function saveLots() {
            localStorage.setItem('pokemonLots', JSON.stringify(lots));
        }

        function loadLots() {
            const saved = localStorage.getItem('pokemonLots');
            return saved ? JSON.parse(saved) : [];
        }

        function showTab(tab) {
            const allMenus = document.querySelectorAll('.dropdown-content');
            allMenus.forEach(m => m.classList.remove('show'));
            
            document.getElementById('content-home').style.display = 'none';
            document.getElementById('content-card-search').style.display = 'none';
            document.getElementById('content-add-collection').style.display = 'none';
            document.getElementById('content-my-collection').style.display = 'none';
            document.getElementById('content-add-sale').style.display = 'none';
            document.getElementById('content-sale-list').style.display = 'none';
            document.getElementById('content-dashboard').style.display = 'none';
            document.getElementById('content-stock-add').style.display = 'none';
            document.getElementById('content-stock-list').style.display = 'none';
            document.getElementById('content-stock-lots').style.display = 'none';

            if (tab === 'home') {
                document.getElementById('content-home').style.display = 'block';
            } else if (tab === 'card-search') {
                document.getElementById('content-card-search').style.display = 'block';
            } else if (tab === 'add-collection') {
                document.getElementById('content-add-collection').style.display = 'block';
            } else if (tab === 'my-collection') {
                document.getElementById('content-my-collection').style.display = 'block';
                filterProducts();
            } else if (tab === 'add-sale') {
                document.getElementById('content-add-sale').style.display = 'block';
            } else if (tab === 'sale-list') {
                document.getElementById('content-sale-list').style.display = 'block';
                filterSaleProducts();
            } else if (tab === 'dashboard') {
                document.getElementById('content-dashboard').style.display = 'block';
                updateDashboard();
            } else if (tab === 'stock-add') {
                document.getElementById('content-stock-add').style.display = 'block';
            } else if (tab === 'stock-list') {
                document.getElementById('content-stock-list').style.display = 'block';
                filterStockItems();
            } else if (tab === 'stock-lots') {
                document.getElementById('content-stock-lots').style.display = 'block';
                updateLotSelect();
                renderLotsTable();
            }
        }

        // === CARD SEARCH API FUNCTIONS ===

        const pokemonTranslations = {
            'bulbizarre': 'bulbasaur', 'herbizarre': 'ivysaur', 'florizarre': 'venusaur',
            'salam√®che': 'charmander', 'reptincel': 'charmeleon', 'dracaufeu': 'charizard',
            'carapuce': 'squirtle', 'carabaffe': 'wartortle', 'tortank': 'blastoise',
            'chenipan': 'caterpie', 'chrysacier': 'metapod', 'papilusion': 'butterfree',
            'aspicot': 'weedle', 'coconfort': 'kakuna', 'dardargnan': 'beedrill',
            'roucool': 'pidgey', 'roucoups': 'pidgeotto', 'roucarnage': 'pidgeot',
            'rattata': 'rattata', 'rattatac': 'raticate', 'piafabec': 'spearow', 'rapasdepic': 'fearow',
            'abo': 'ekans', 'arbok': 'arbok', 'pikachu': 'pikachu', 'raichu': 'raichu',
            'sabelette': 'sandshrew', 'sablaireau': 'sandslash', 'nidoran‚ôÄ': 'nidoran-f', 'nidorina': 'nidorina',
            'nidoqueen': 'nidoqueen', 'nidoran‚ôÇ': 'nidoran-m', 'nidorino': 'nidorino', 'nidoking': 'nidoking',
            'm√©lof√©e': 'clefairy', 'm√©lodelfe': 'clefable', 'goupix': 'vulpix', 'feunard': 'ninetales',
            'rondoudou': 'jigglypuff', 'grodoudou': 'wigglytuff', 'nosferapti': 'zubat', 'nosferalto': 'golbat',
            'mystherbe': 'oddish', 'ortide': 'gloom', 'rafflesia': 'vileplume', 'paras': 'paras',
            'parasect': 'parasect', 'mimitoss': 'venonat', 'a√©romite': 'venomoth', 'taupiqueur': 'diglett',
            'triopikeur': 'dugtrio', 'miaouss': 'meowth', 'persian': 'persian', 'psykokwak': 'psyduck',
            'akwakwak': 'golduck', 'f√©rosinge': 'mankey', 'colossinge': 'primeape', 'caninos': 'growlithe',
            'arcanin': 'arcanine', 'ptitard': 'poliwag', 't√™tarte': 'poliwhirl', 'tartard': 'poliwrath',
            'abra': 'abra', 'kadabra': 'kadabra', 'alakazam': 'alakazam', 'machoc': 'machop',
            'machopeur': 'machoke', 'mackogneur': 'machamp', 'ch√©tiflor': 'bellsprout', 'boustiflor': 'weepinbell',
            'empiflor': 'victreebel', 'tentacool': 'tentacool', 'tentacruel': 'tentacruel', 'racaillou': 'geodude',
            'gravalanch': 'graveler', 'grolem': 'golem', 'ponyta': 'ponyta', 'galopa': 'rapidash',
            'ramoloss': 'slowpoke', 'flagadoss': 'slowbro', 'magn√©ti': 'magnemite', 'magn√©ton': 'magneton',
            'canarticho': 'farfetchd', 'doduo': 'doduo', 'dodrio': 'dodrio', 'otaria': 'seel',
            'lamantine': 'dewgong', 'tadmorv': 'grimer', 'grotadmorv': 'muk', 'kokiyas': 'shellder',
            'crustabri': 'cloyster', 'fantominus': 'gastly', 'spectrum': 'haunter', 'ectoplasma': 'gengar',
            'onix': 'onix', 'soporifik': 'drowzee', 'hypnomade': 'hypno', 'krabby': 'krabby',
            'krabboss': 'kingler', 'voltorbe': 'voltorb', '√©lectrode': 'electrode', 'noeunoeuf': 'exeggcute',
            'noadkoko': 'exeggutor', 'osselait': 'cubone', 'ossatueur': 'marowak', 'kicklee': 'hitmonlee',
            'tygnon': 'hitmonchan', 'excelangue': 'lickitung', 'smogo': 'koffing', 'smogogo': 'weezing',
            'rhinocorne': 'rhyhorn', 'rhinof√©ros': 'rhydon', 'leveinard': 'chansey', 'saquedeneu': 'tangela',
            'kangourex': 'kangaskhan', 'hypotrempe': 'horsea', 'hypoc√©an': 'seadra', 'poissir√®ne': 'goldeen',
            'poissoroy': 'seaking', 'stari': 'staryu', 'staross': 'starmie', 'M.mime': 'mr-mime',
            'ins√©cateur': 'scyther', 'lippoutou': 'jynx', '√©lektek': 'electabuzz', 'magmar': 'magmar',
            'scarabrute': 'pinsir', 'tauros': 'tauros', 'magicarpe': 'magikarp', 'l√©viator': 'gyarados',
            'lokhlass': 'lapras', 'm√©tamorph': 'ditto', '√©voli': 'eevee', 'aquali': 'vaporeon',
            'voltali': 'jolteon', 'pyroli': 'flareon', 'porygon': 'porygon', 'amonita': 'omanyte',
            'amonistar': 'omastar', 'kabuto': 'kabuto', 'kabutops': 'kabutops', 'pt√©ra': 'aerodactyl',
            'ronflex': 'snorlax', 'artikodin': 'articuno', '√©lecthor': 'zapdos', 'sulfura': 'moltres',
            'minidraco': 'dratini', 'draco': 'dragonair', 'dracolosse': 'dragonite', 'mewtwo': 'mewtwo',
            'mew': 'mew',
            'germignon': 'chikorita', 'macronium': 'bayleef', 'm√©ganium': 'meganium',
            'h√©ricendre': 'cyndaquil', 'feurisson': 'quilava', 'typhlosion': 'typhlosion',
            'kaiminus': 'totodile', 'crocrodil': 'croconaw', 'aligatueur': 'feraligatr',
            'fouinette': 'sentret', 'fouinar': 'furret', 'hoothoot': 'hoothoot', 'noarfang': 'noctowl',
            'coxy': 'ledyba', 'coxyclaque': 'ledian', 'mimigal': 'spinarak', 'migalos': 'ariados',
            'nostenfer': 'crobat', 'loupio': 'chinchou', 'lanturn': 'lanturn', 'pichu': 'pichu',
            'm√©lo': 'cleffa', 'toudoudou': 'igglybuff', 'togepi': 'togepi', 'togetic': 'togetic',
            'natu': 'natu', 'xatu': 'xatu', 'wattouat': 'mareep', 'lainergie': 'flaaffy',
            'pharamp': 'ampharos', 'joliflor': 'bellossom', 'marill': 'marill', 'azumarill': 'azumarill',
            'simularbre': 'sudowoodo', 'tarpaud': 'politoed', 'granivol': 'hoppip', 'floravol': 'skiploom',
            'cotovol': 'jumpluff', 'capumain': 'aipom', 'tournegrin': 'sunkern', 'h√©liatronc': 'sunflora',
            'yanma': 'yanma', 'axoloto': 'wooper', 'maraiste': 'quagsire', 'mentali': 'espeon',
            'noctali': 'umbreon', 'corn√®bre': 'murkrow', 'feufor√™ve': 'misdreavus', 'zarbi': 'unown',
            'qulbutok√©': 'wobbuffet', 'girafarig': 'girafarig', 'pomdepik': 'pineco', 'foretress': 'forretress',
            'insolourdo': 'dunsparce', 'scorplane': 'gligar', 'steelix': 'steelix', 'snubbull': 'snubbull',
            'granbull': 'granbull', 'qwilfish': 'qwilfish', 'cizayox': 'scizor', 'caratroc': 'shuckle',
            'scarhino': 'heracross', 'farfuret': 'sneasel', 'teddiursa': 'teddiursa', 'ursaring': 'ursaring',
            'limagma': 'slugma', 'volcaropod': 'magcargo', 'marcacrin': 'swinub', 'cochignon': 'piloswine',
            'corayon': 'corsola', 'r√©moraid': 'remoraid', 'octillery': 'octillery', 'cadoizo': 'delibird',
            'd√©manta': 'mantine', 'airmure': 'skarmory', 'malosse': 'houndour', 'd√©molosse': 'houndoom',
            'hyporoi': 'kingdra', 'phanpy': 'phanpy', 'donphan': 'donphan', 'porygon2': 'porygon2',
            'cerfrousse': 'stantler', 'queulorior': 'smeargle', 'debugant': 'tyrogue', 'kapoera': 'hitmontop',
            'lippouti': 'smoochum', '√©lekid': 'elekid', 'magby': 'magby', '√©cr√©meuh': 'miltank',
            'leuphorie': 'blissey', 'raikou': 'raikou', 'entei': 'entei', 'suicune': 'suicune',
            'embrylex': 'larvitar', 'ymphect': 'pupitar', 'tyranocif': 'tyranitar', 'lugia': 'lugia',
            'ho-oh': 'ho-oh', 'celebi': 'celebi'
        };

        function translatePokemonName(name) {
            const normalized = name.toLowerCase().trim();
            return pokemonTranslations[normalized] || name;
        }

        async function searchCards() {
            const query = document.getElementById('api-search').value.trim();
            const limit = document.getElementById('result-limit').value;
            
            if (!query) {
                alert('Veuillez entrer un terme de recherche');
                return;
            }

            const resultsDiv = document.getElementById('search-results');
            const loadingDiv = document.getElementById('search-loading');
            const infoDiv = document.getElementById('search-info');
            
            resultsDiv.innerHTML = '';
            loadingDiv.style.display = 'block';
            infoDiv.style.display = 'none';

            const startTime = Date.now();

            try {
                const translatedQuery = translatePokemonName(query);
                const displayQuery = translatedQuery !== query.toLowerCase() ? 
                    `${query} (${translatedQuery})` : query;
                
                const url = `https://api.pokemontcg.io/v2/cards?q=name:"${translatedQuery}"&pageSize=${limit}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                const endTime = Date.now();
                const searchTime = ((endTime - startTime) / 1000).toFixed(2);
                
                loadingDiv.style.display = 'none';

                if (!data.data || data.data.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="col-span-full text-center py-8 text-gray-500">
                            Aucune carte trouv√©e pour "${displayQuery}" üòû
                            <br><small>Essayez un autre nom ou v√©rifiez l'orthographe</small>
                        </div>
                    `;
                    return;
                }

                infoDiv.style.display = 'block';
                let infoHTML = `<strong>${data.data.length} carte(s) trouv√©e(s)</strong> en ${searchTime}s`;
                
                if (translatedQuery !== query.toLowerCase()) {
                    infoHTML += ` ‚Ä¢ üîÑ Traduit: <strong>${query}</strong> ‚Üí <strong>${translatedQuery}</strong>`;
                }
                
                if (data.totalCount > data.data.length) {
                    infoHTML += ` ‚Ä¢ <span class="text-orange-600">${data.totalCount} cartes au total (affichage limit√© √† ${limit})</span>`;
                }
                
                infoDiv.innerHTML = infoHTML;

                const fragment = document.createDocumentFragment();
                
                data.data.forEach((card, index) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition';
                    cardDiv.style.animationDelay = `${index * 0.02}s`;
                    
                    const price = card.cardmarket?.prices?.averageSellPrice || card.tcgplayer?.prices?.normal?.market || 0;
                    const rarity = card.rarity || 'Commune';
                    const setName = card.set?.name || 'Inconnu';
                    
                    cardDiv.innerHTML = `
                        <img src="${card.images.small}" 
                             alt="${card.name}" 
                             loading="lazy"
                             class="w-full h-64 object-contain bg-gray-50 p-2">
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-2">${card.name}</h3>
                            <p class="text-sm text-gray-600 mb-1">üé¥ ${setName}</p>
                            <p class="text-sm text-gray-600 mb-1">‚ú® ${rarity}</p>
                            <p class="text-sm font-semibold text-green-600 mb-3">üí∞ ~${price > 0 ? price.toFixed(2) : '?'}‚Ç¨</p>
                            <button onclick='addCardToCollection(${JSON.stringify(card).replace(/'/g, "&#39;")})' 
                                class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 font-semibold">
                                ‚ûï Ajouter
                            </button>
                        </div>
                    `;
                    
                    fragment.appendChild(cardDiv);
                });
                
                resultsDiv.appendChild(fragment);
                
            } catch (error) {
                loadingDiv.style.display = 'none';
                resultsDiv.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="text-red-500 text-xl mb-2">‚ùå Erreur lors de la recherche</div>
                        <div class="text-sm text-gray-600">D√©tails: ${error.message}</div>
                        <div class="text-xs text-gray-500 mt-2">V√©rifiez votre connexion internet</div>
                    </div>
                `;
            }
        }

        function addCardToCollection(card) {
            const price = card.cardmarket?.prices?.averageSellPrice || 0;
            
            const newProduct = {
                id: Date.now(),
                collection: 'Carte √† l\'unit√©',
                ere: determineEra(card.set?.series || ''),
                nom: `${card.name} - ${card.set?.name || ''} #${card.number}`,
                prix: price,
                prixRevente: price,
                etat: 'Neuf',
                lieu: 'API Pok√©mon TCG',
                details: `Raret√©: ${card.rarity || 'Commune'}`,
                image: card.images.large
            };

            products.push(newProduct);
            saveProducts();
            updateSummary();
            
            alert(`‚úÖ "${card.name}" ajout√© √† votre collection !`);
        }

        function determineEra(series) {
            const eraMap = {
                'Scarlet & Violet': 'EV',
                'Sword & Shield': 'EB',
                'Sun & Moon': 'SL',
                'XY': 'XY',
                'Black & White': 'NB',
                'Diamond & Pearl': 'DP',
                'EX': 'EX',
                'Base': 'WIZARD'
            };
            
            for (const [key, value] of Object.entries(eraMap)) {
                if (series.includes(key)) return value;
            }
            return 'EV';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('api-search');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchCards();
                });
            }
        });

        // === COLLECTION FUNCTIONS ===
        
        function handleImage(event) {
            const file = event.target.files[0];
            if (file && ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    currentImage = reader.result;
                    document.getElementById('image-status').innerHTML = '<span class="text-green-600 text-sm">‚úì Image ajout√©e</span>';
                };
                reader.readAsDataURL(file);
            } else {
                alert('Format non support√©. Utilisez JPG, JPEG, PNG ou WEBP');
            }
        }

        function addProduct() {
            const nom = document.getElementById('nom').value;
            const prix = parseFloat(document.getElementById('prix').value);
            
            if (!nom || !prix) {
                alert('Veuillez remplir au moins le nom et le prix d\'achat');
                return;
            }

            const product = {
                id: editingProductId || Date.now(),
                collection: document.getElementById('collection').value,
                ere: document.getElementById('ere').value,
                nom: nom,
                prix: prix,
                prixRevente: parseFloat(document.getElementById('prix-revente').value) || 0,
                etat: document.getElementById('etat').value,
                lieu: document.getElementById('lieu').value,
                details: document.getElementById('details').value,
                image: currentImage
            };

            if (editingProductId) {
                const index = products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    products[index] = product;
                }
                editingProductId = null;
            } else {
                products.push(product);
            }
            
            saveProducts();
            resetForm();
            updateSummary();
            filterProducts();
        }

        function resetForm() {
            document.getElementById('nom').value = '';
            document.getElementById('prix').value = '';
            document.getElementById('prix-revente').value = '';
            document.getElementById('lieu').value = '';
            document.getElementById('details').value = '';
            document.getElementById('image').value = '';
            document.getElementById('image-status').innerHTML = '';
            document.getElementById('submit-btn-text').textContent = '‚ûï Ajouter';
            document.getElementById('cancel-btn').style.display = 'none';
            currentImage = null;
            editingProductId = null;
        }

        function cancelEdit() {
            resetForm();
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            editingProductId = id;
            document.getElementById('collection').value = product.collection;
            document.getElementById('ere').value = product.ere;
            document.getElementById('nom').value = product.nom;
            document.getElementById('prix').value = product.prix;
            document.getElementById('prix-revente').value = product.prixRevente || '';
            document.getElementById('etat').value = product.etat;
            document.getElementById('lieu').value = product.lieu;
            document.getElementById('details').value = product.details;
            currentImage = product.image;
            
            if (product.image) {
                document.getElementById('image-status').innerHTML = '<span class="text-green-600 text-sm">‚úì Image ajout√©e</span>';
            }

            document.getElementById('submit-btn-text').textContent = 'üíæ Modifier';
            document.getElementById('cancel-btn').style.display = 'inline-block';

            showTab('add-collection');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteProduct(id) {
            if (confirm('Supprimer ce produit ?')) {
                products = products.filter(p => p.id !== id);
                saveProducts();
                updateSummary();
                filterProducts();
            }
        }

        function updateSummary() {
            const total = products.length;
            const totalValue = products.reduce((sum, p) => sum + p.prix, 0);
            const totalResale = products.reduce((sum, p) => sum + (p.prixRevente || 0), 0);

            document.getElementById('total-products').textContent = total;
            document.getElementById('total-value').textContent = totalValue.toFixed(2) + '‚Ç¨';
            document.getElementById('total-resale').textContent = totalResale.toFixed(2) + '‚Ç¨';

            const globalPercentageElement = document.getElementById('global-percentage');
            if (totalResale > 0 && totalValue > 0) {
                const percentage = ((totalResale - totalValue) / totalValue * 100).toFixed(2);
                const isPositive = percentage >= 0;
                const color = isPositive ? 'text-green-700' : 'text-red-700';
                const icon = isPositive ? 'üìà' : 'üìâ';
                globalPercentageElement.className = `text-3xl font-bold ${color}`;
                globalPercentageElement.textContent = `${icon} ${isPositive ? '+' : ''}${percentage}%`;
            } else {
                globalPercentageElement.className = 'text-3xl font-bold text-gray-700';
                globalPercentageElement.textContent = '-';
            }
        }

        function filterProducts() {
            const search = document.getElementById('search').value.toLowerCase();
            const filterCol = document.getElementById('filter-collection').value;
            const filterEre = document.getElementById('filter-ere').value;
            const filterEtat = document.getElementById('filter-etat').value;
            const sort = document.getElementById('sort').value;

            let filtered = products.filter(p => {
                const matchSearch = p.nom.toLowerCase().includes(search) || p.collection.toLowerCase().includes(search);
                const matchCol = !filterCol || p.collection === filterCol;
                const matchEre = !filterEre || p.ere === filterEre;
                const matchEtat = !filterEtat || p.etat === filterEtat;
                return matchSearch && matchCol && matchEre && matchEtat;
            });

            if (sort === 'nom') filtered.sort((a, b) => a.nom.localeCompare(b.nom));
            if (sort === 'collection') filtered.sort((a, b) => a.collection.localeCompare(b.collection));
            if (sort === 'prix-asc') filtered.sort((a, b) => a.prix - b.prix);
            if (sort === 'prix-desc') filtered.sort((a, b) => b.prix - a.prix);

            const totalValue = filtered.reduce((sum, p) => sum + p.prix, 0);
            document.getElementById('filter-summary').textContent = 
                `${filtered.length} produit(s) ‚Ä¢ Valeur totale: ${totalValue.toFixed(2)}‚Ç¨`;

            renderTable(filtered);
        }

        function renderTable(productList) {
            const tbody = document.getElementById('product-table');
            tbody.innerHTML = '';

            productList.forEach((product, idx) => {
                const etatClass = {
                    'Neuf': 'bg-green-100 text-green-800',
                    'Excellent': 'bg-blue-100 text-blue-800',
                    'Bon': 'bg-yellow-100 text-yellow-800',
                    'Moyen': 'bg-orange-100 text-orange-800',
                    'Ab√Æm√©': 'bg-red-100 text-red-800'
                }[product.etat];

                let percentageHtml = '-';
                if (product.prixRevente && product.prix) {
                    const percentage = ((product.prixRevente - product.prix) / product.prix * 100).toFixed(2);
                    const isPositive = percentage >= 0;
                    const color = isPositive ? 'text-green-600' : 'text-red-600';
                    const icon = isPositive ? 'üìà' : 'üìâ';
                    percentageHtml = `<span class="${color} font-bold">${icon} ${isPositive ? '+' : ''}${percentage}%</span>`;
                }

                const row = `
                    <tr class="${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        <td class="px-4 py-3">
                            ${product.image 
                                ? `<img src="${product.image}" alt="${product.nom}" class="w-16 h-16 object-cover rounded">`
                                : '<div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-gray-400">üì∑</div>'
                            }
                        </td>
                        <td class="px-4 py-3 font-bold ${collectionColors[product.collection]}">${product.collection}</td>
                        <td class="px-4 py-3 font-semibold text-blue-600">${product.ere}</td>
                        <td class="px-4 py-3">${product.nom}</td>
                        <td class="px-4 py-3 font-semibold">${product.prix.toFixed(2)}‚Ç¨</td>
                        <td class="px-4 py-3 font-semibold">${product.prixRevente ? product.prixRevente.toFixed(2) + '‚Ç¨' : '-'}</td>
                        <td class="px-4 py-3">${percentageHtml}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${etatClass}">${product.etat}</span>
                        </td>
                        <td class="px-4 py-3">${product.lieu}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${product.details}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="editProduct(${product.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Modifier">‚öôÔ∏è</button>
                            <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-800" title="Supprimer">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // === SALE FUNCTIONS ===

        function handleSaleImages(event) {
            const files = Array.from(event.target.files);
            if (files.length > 4) {
                alert('Maximum 4 images autoris√©es');
                return;
            }

            currentSaleImages = [];
            const preview = document.getElementById('sale-images-preview');
            preview.innerHTML = '';

            let processed = 0;
            files.forEach((file, idx) => {
                if (['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        currentSaleImages.push(reader.result);
                        const img = document.createElement('img');
                        img.src = reader.result;
                        img.className = 'w-20 h-20 object-cover rounded border';
                        preview.appendChild(img);
                        
                        processed++;
                        if (processed === files.length) {
                            document.getElementById('sale-images-status').innerHTML = 
                                `<span class="text-green-600 text-sm">‚úì ${currentSaleImages.length} image(s) ajout√©e(s)</span>`;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function addSaleProduct() {
            const nom = document.getElementById('sale-nom').value;
            const prixAchat = parseFloat(document.getElementById('sale-prix-achat').value);
            
            if (!nom || !prixAchat) {
                alert('Veuillez remplir au moins le nom et le prix d\'achat');
                return;
            }

            const saleProduct = {
                id: editingSaleId || Date.now(),
                nom: nom,
                etat: document.getElementById('sale-etat').value,
                prixAchat: prixAchat,
                statut: document.getElementById('sale-statut').value,
                prixPotentiel: parseFloat(document.getElementById('sale-prix-potentiel').value) || 0,
                prixRevente: parseFloat(document.getElementById('sale-prix-revente').value) || 0,
                details: document.getElementById('sale-details').value,
                images: currentSaleImages,
                dateVente: document.getElementById('sale-statut').value === 'Vendu' ? new Date().toISOString() : null
            };

            if (editingSaleId) {
                const index = saleProducts.findIndex(p => p.id === editingSaleId);
                if (index !== -1) {
                    if (saleProduct.statut === 'Vendu' && !saleProducts[index].dateVente) {
                        saleProduct.dateVente = new Date().toISOString();
                    }
                    saleProducts[index] = saleProduct;
                }
                editingSaleId = null;
            } else {
                saleProducts.push(saleProduct);
            }
            
            saveSaleProducts();
            resetSaleForm();
            filterSaleProducts();
        }

        function resetSaleForm() {
            document.getElementById('sale-nom').value = '';
            document.getElementById('sale-prix-achat').value = '';
            document.getElementById('sale-prix-potentiel').value = '';
            document.getElementById('sale-prix-revente').value = '';
            document.getElementById('sale-details').value = '';
            document.getElementById('sale-images').value = '';
            document.getElementById('sale-images-status').innerHTML = '';
            document.getElementById('sale-images-preview').innerHTML = '';
            document.getElementById('sale-submit-btn-text').textContent = '‚ûï Ajouter';
            document.getElementById('sale-cancel-btn').style.display = 'none';
            currentSaleImages = [];
            editingSaleId = null;
        }

        function cancelSaleEdit() {
            resetSaleForm();
        }

        function editSaleProduct(id) {
            const product = saleProducts.find(p => p.id === id);
            if (!product) return;

            editingSaleId = id;
            document.getElementById('sale-nom').value = product.nom;
            document.getElementById('sale-etat').value = product.etat;
            document.getElementById('sale-prix-achat').value = product.prixAchat;
            document.getElementById('sale-statut').value = product.statut;
            document.getElementById('sale-prix-potentiel').value = product.prixPotentiel || '';
            document.getElementById('sale-prix-revente').value = product.prixRevente || '';
            document.getElementById('sale-details').value = product.details;
            currentSaleImages = product.images || [];
            
            const preview = document.getElementById('sale-images-preview');
            preview.innerHTML = '';
            currentSaleImages.forEach(img => {
                const imgEl = document.createElement('img');
                imgEl.src = img;
                imgEl.className = 'w-20 h-20 object-cover rounded border';
                preview.appendChild(imgEl);
            });

            if (currentSaleImages.length > 0) {
                document.getElementById('sale-images-status').innerHTML = 
                    `<span class="text-green-600 text-sm">‚úì ${currentSaleImages.length} image(s) ajout√©e(s)</span>`;
            }

            document.getElementById('sale-submit-btn-text').textContent = 'üíæ Modifier';
            document.getElementById('sale-cancel-btn').style.display = 'inline-block';

            showTab('add-sale');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteSaleProduct(id) {
            if (confirm('Supprimer ce produit ?')) {
                saleProducts = saleProducts.filter(p => p.id !== id);
                saveSaleProducts();
                filterSaleProducts();
                updateDashboard();
            }
        }

        function filterSaleProducts() {
            const search = document.getElementById('sale-search').value.toLowerCase();

            let filtered = saleProducts.filter(p => {
                return p.nom.toLowerCase().includes(search);
            });

            renderSaleTable(filtered);
        }

        function renderSaleTable(productList) {
            const tbody = document.getElementById('sale-table');
            tbody.innerHTML = '';

            productList.forEach((product, idx) => {
                const etatClass = {
                    'Neuf': 'bg-green-100 text-green-800',
                    'Excellent': 'bg-blue-100 text-blue-800',
                    'Bon': 'bg-yellow-100 text-yellow-800',
                    'Moyen': 'bg-orange-100 text-orange-800',
                    'Ab√Æm√©': 'bg-red-100 text-red-800'
                }[product.etat];

                const statutClass = {
                    'En vente': 'bg-blue-100 text-blue-800',
                    'Vendu': 'bg-green-100 text-green-800',
                    'Pas list√©': 'bg-gray-100 text-gray-800'
                }[product.statut];

                const imagesHtml = (product.images && product.images.length > 0)
                    ? product.images.map(img => `<img src="${img}" class="w-12 h-12 object-cover rounded inline-block mr-1">`).join('')
                    : '<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-gray-400">üì∑</div>';

                const rowClass = product.statut === 'Vendu' ? 'bg-green-50' : (idx % 2 === 0 ? 'bg-gray-50' : 'bg-white');

                const row = `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3">${imagesHtml}</td>
                        <td class="px-4 py-3 font-semibold">${product.nom}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${etatClass}">${product.etat}</span>
                        </td>
                        <td class="px-4 py-3">${product.prixAchat.toFixed(2)}‚Ç¨</td>
                        <td class="px-4 py-3">${product.prixPotentiel ? product.prixPotentiel.toFixed(2) + '‚Ç¨' : '-'}</td>
                        <td class="px-4 py-3 font-semibold">${product.prixRevente ? product.prixRevente.toFixed(2) + '‚Ç¨' : '-'}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${statutClass}">${product.statut}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${product.details}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="editSaleProduct(${product.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Modifier">‚öôÔ∏è</button>
                            <button onclick="deleteSaleProduct(${product.id})" class="text-red-600 hover:text-red-800" title="Supprimer">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateDashboard() {
            const soldProducts = saleProducts.filter(p => p.statut === 'Vendu' && p.prixRevente > 0);
            const soldCount = soldProducts.length;
            const totalRevenue = soldProducts.reduce((sum, p) => sum + p.prixRevente, 0);
            const totalCost = soldProducts.reduce((sum, p) => sum + p.prixAchat, 0);
            const netProfit = totalRevenue - totalCost;

            document.getElementById('sold-count').textContent = soldCount;
            document.getElementById('total-revenue').textContent = totalRevenue.toFixed(2) + '‚Ç¨';
            document.getElementById('net-profit').textContent = netProfit.toFixed(2) + '‚Ç¨';

            const salesByMonth = {};
            soldProducts.forEach(p => {
                if (p.dateVente) {
                    const date = new Date(p.dateVente);
                    const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                    if (!salesByMonth[monthYear]) {
                        salesByMonth[monthYear] = 0;
                    }
                    salesByMonth[monthYear] += p.prixRevente;
                }
            });

            const sortedMonths = Object.keys(salesByMonth).sort((a, b) => {
                const [ma, ya] = a.split('/').map(Number);
                const [mb, yb] = b.split('/').map(Number);
                return (ya - yb) || (ma - mb);
            });

            const chartData = {
                labels: sortedMonths,
                datasets: [{
                    label: 'Revenus (‚Ç¨)',
                    data: sortedMonths.map(m => salesByMonth[m]),
                    backgroundColor: 'rgba(147, 51, 234, 0.2)',
                    borderColor: 'rgba(147, 51, 234, 1)',
                    borderWidth: 2,
                    tension: 0.4
                }]
            };

            if (salesChart) {
                salesChart.destroy();
            }

            const ctx = document.getElementById('salesChart');
            salesChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }

        // === STOCK FUNCTIONS ===

        function handleStockPhoto(event) {
            const file = event.target.files[0];
            if (file && ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    currentStockPhoto = reader.result;
                    document.getElementById('stock-photo-status').innerHTML = '<span class="text-green-600 text-sm">‚úì Photo ajout√©e</span>';
                    
                    const preview = document.getElementById('stock-photo-preview');
                    const img = document.getElementById('stock-photo-img');
                    img.src = currentStockPhoto;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                alert('Format non support√©. Utilisez JPG, JPEG, PNG ou WEBP');
            }
        }

        function zoomStockPhoto() {
            if (currentStockPhoto) {
                document.getElementById('photo-zoom-img').src = currentStockPhoto;
                document.getElementById('photo-zoom-modal').style.display = 'flex';
            }
        }

        function closePhotoZoom() {
            document.getElementById('photo-zoom-modal').style.display = 'none';
        }

        function zoomTablePhoto(photoSrc) {
            document.getElementById('photo-zoom-img').src = photoSrc;
            document.getElementById('photo-zoom-modal').style.display = 'flex';
        }

        function addStockItem() {
            const prixAchat = parseFloat(document.getElementById('stock-prix-achat').value);
            
            if (!prixAchat) {
                alert('Veuillez au moins renseigner le prix d\'achat');
                return;
            }

            const dateInput = document.getElementById('stock-date').value;
            const dateAchat = dateInput ? new Date(dateInput).toISOString() : new Date().toISOString();

            const stockItem = {
                id: editingStockId || Date.now(),
                objet: document.getElementById('stock-objet').value,
                photo: currentStockPhoto,
                collection: document.getElementById('stock-collection').value,
                dateAchat: dateAchat,
                etat: document.getElementById('stock-etat').value,
                detailsEtat: document.getElementById('stock-details-etat').value,
                lieuAchat: document.getElementById('stock-achat-lieu').value,
                prixAchat: prixAchat,
                prixRevente: parseFloat(document.getElementById('stock-prix-revente').value) || 0,
                etatActuel: document.getElementById('stock-etat-actuel').value,
                lot: document.getElementById('stock-lot').value,
                details: document.getElementById('stock-details').value
            };

            if (editingStockId) {
                const index = stockItems.findIndex(p => p.id === editingStockId);
                if (index !== -1) {
                    stockItems[index] = stockItem;
                }
                editingStockId = null;
            } else {
                stockItems.push(stockItem);
            }
            
            saveStockItems();
            resetStockForm();
            filterStockItems();
            alert('‚úÖ Article ajout√© au stock !');
        }

        function resetStockForm() {
            document.getElementById('stock-prix-achat').value = '';
            document.getElementById('stock-prix-revente').value = '';
            document.getElementById('stock-details-etat').value = '';
            document.getElementById('stock-details').value = '';
            document.getElementById('stock-date').value = '';
            document.getElementById('stock-photo').value = '';
            document.getElementById('stock-photo-status').innerHTML = '';
            document.getElementById('stock-photo-preview').style.display = 'none';
            document.getElementById('stock-submit-btn-text').textContent = '‚ûï Ajouter au stock';
            document.getElementById('stock-cancel-btn').style.display = 'none';
            currentStockPhoto = null;
            editingStockId = null;
        }

        function cancelStockEdit() {
            resetStockForm();
        }

        function editStockItem(id) {
            const item = stockItems.find(p => p.id === id);
            if (!item) return;

            editingStockId = id;
            document.getElementById('stock-objet').value = item.objet;
            document.getElementById('stock-collection').value = item.collection;
            
            if (item.dateAchat) {
                const date = new Date(item.dateAchat);
                const localDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('stock-date').value = localDate;
            }
            
            document.getElementById('stock-etat').value = item.etat;
            document.getElementById('stock-details-etat').value = item.detailsEtat;
            document.getElementById('stock-achat-lieu').value = item.lieuAchat;
            document.getElementById('stock-prix-achat').value = item.prixAchat;
            document.getElementById('stock-prix-revente').value = item.prixRevente || '';
            document.getElementById('stock-etat-actuel').value = item.etatActuel;
            document.getElementById('stock-lot').value = item.lot || '';
            document.getElementById('stock-details').value = item.details;
            currentStockPhoto = item.photo;
            
            if (item.photo) {
                document.getElementById('stock-photo-status').innerHTML = '<span class="text-green-600 text-sm">‚úì Photo ajout√©e</span>';
                const preview = document.getElementById('stock-photo-preview');
                const img = document.getElementById('stock-photo-img');
                img.src = item.photo;
                preview.style.display = 'block';
            }

            document.getElementById('stock-submit-btn-text').textContent = 'üíæ Modifier';
            document.getElementById('stock-cancel-btn').style.display = 'inline-block';

            showTab('stock-add');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteStockItem(id) {
            if (confirm('Supprimer cet article du stock ?')) {
                stockItems = stockItems.filter(p => p.id !== id);
                saveStockItems();
                filterStockItems();
            }
        }

        function filterStockItems() {
            const search = document.getElementById('stock-search').value.toLowerCase();

            let filtered = stockItems.filter(p => {
                return p.objet.toLowerCase().includes(search) || 
                       p.collection.toLowerCase().includes(search) ||
                       p.etatActuel.toLowerCase().includes(search) ||
                       (p.lot && p.lot.toString().toLowerCase().includes(search));
            });

            const enStock = filtered.filter(item => item.etatActuel === 'Stock');
            const enVente = filtered.filter(item => item.etatActuel === 'En vente');
            const vendus = filtered.filter(item => item.etatActuel === 'Vendu');

            renderStockTable('stock-table-stock', enStock);
            renderStockTable('stock-table-vente', enVente);
            renderStockTable('stock-table-vendu', vendus);
        }

        function changeStockStatus(id, newStatus) {
            const item = stockItems.find(p => p.id === id);
            if (item) {
                item.etatActuel = newStatus;
                saveStockItems();
                filterStockItems();
            }
        }

        function renderStockTable(tableId, itemList) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';

            itemList.forEach((item, idx) => {
                const etatClass = {
                    'Neuf': 'bg-green-100 text-green-800',
                    'Excellent': 'bg-blue-100 text-blue-800',
                    'Bon': 'bg-yellow-100 text-yellow-800',
                    'Moyen': 'bg-orange-100 text-orange-800',
                    'Ab√Æm√©': 'bg-red-100 text-red-800'
                }[item.etat];

                const statutClass = {
                    'Stock': 'bg-blue-100 text-blue-800',
                    'En vente': 'bg-orange-100 text-orange-800',
                    'Vendu': 'bg-green-100 text-green-800'
                }[item.etatActuel];

                const photoHtml = item.photo
                    ? `<img src="${item.photo}" class="w-16 h-16 object-cover rounded cursor-pointer" onclick="zoomTablePhoto('${item.photo}')" alt="Photo">`
                    : '<div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-gray-400">üì∑</div>';

                const dateFormatted = item.dateAchat ? new Date(item.dateAchat).toLocaleString('fr-FR') : '-';

                const lotName = item.lot ? (lots.find(l => l.id == item.lot)?.nom || item.lot) : '-';

                let valueHtml = '-';
                if (item.prixRevente && item.prixAchat) {
                    const percentage = ((item.prixRevente - item.prixAchat) / item.prixAchat * 100).toFixed(2);
                    const isPositive = percentage >= 0;
                    const color = isPositive ? 'text-green-600' : 'text-red-600';
                    const icon = isPositive ? 'üìà' : 'üìâ';
                    valueHtml = `<span class="${color} font-bold">${icon} ${isPositive ? '+' : ''}${percentage}%</span>`;
                }

                const detailsHtml = item.details 
                    ? `<span class="cursor-help relative group">üí¨
                        <span class="invisible group-hover:visible absolute left-0 top-6 bg-black text-white text-xs rounded p-2 w-48 z-10">
                            ${item.details}
                        </span>
                       </span>`
                    : '-';

                const rowClass = idx % 2 === 0 ? 'bg-gray-50' : 'bg-white';

                const row = `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3">${photoHtml}</td>
                        <td class="px-4 py-3 font-semibold">${item.objet}</td>
                        <td class="px-4 py-3">${item.collection}</td>
                        <td class="px-4 py-3 text-sm">${dateFormatted}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${etatClass}">${item.etat}</span>
                            ${item.detailsEtat ? `<br><small class="text-gray-500">${item.detailsEtat}</small>` : ''}
                        </td>
                        <td class="px-4 py-3">${item.lieuAchat}</td>
                        <td class="px-4 py-3 text-sm">${lotName}</td>
                        <td class="px-4 py-3 font-semibold">${item.prixAchat.toFixed(2)}‚Ç¨</td>
                        <td class="px-4 py-3 font-semibold">${item.prixRevente ? item.prixRevente.toFixed(2) + '‚Ç¨' : '-'}</td>
                        <td class="px-4 py-3">${valueHtml}</td>
                        <td class="px-4 py-3">
                            <select onchange="changeStockStatus(${item.id}, this.value)" class="px-2 py-1 rounded text-xs font-semibold ${statutClass} border-none">
                                <option value="Stock" ${item.etatActuel === 'Stock' ? 'selected' : ''}>Stock</option>
                                <option value="En vente" ${item.etatActuel === 'En vente' ? 'selected' : ''}>En vente</option>
                                <option value="Vendu" ${item.etatActuel === 'Vendu' ? 'selected' : ''}>Vendu</option>
                            </select>
                        </td>
                        <td class="px-4 py-3">${detailsHtml}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="editStockItem(${item.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Modifier">‚öôÔ∏è</button>
                            <button onclick="deleteStockItem(${item.id})" class="text-red-600 hover:text-red-800" title="Supprimer">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // === LOTS FUNCTIONS ===

        function openCreateLotModal() {
            document.getElementById('create-lot-modal').style.display = 'flex';
        }

        function closeCreateLotModal(event) {
            if (!event || event.target.id === 'create-lot-modal') {
                document.getElementById('create-lot-modal').style.display = 'none';
                document.getElementById('lot-nom').value = '';
                document.getElementById('lot-date').value = '';
                document.getElementById('lot-prix').value = '';
                document.getElementById('lot-nb-cartes').value = '';
                document.getElementById('lot-details').value = '';
                document.getElementById('lot-photo').value = '';
                document.getElementById('lot-photo-status').innerHTML = '';
                currentLotPhoto = null;
            }
        }

        function handleLotPhoto(event) {
            const file = event.target.files[0];
            if (file && ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    currentLotPhoto = reader.result;
                    document.getElementById('lot-photo-status').innerHTML = '<span class="text-green-600 text-sm">‚úì</span>';
                };
                reader.readAsDataURL(file);
            } else {
                alert('Format non support√©. Utilisez JPG, JPEG, PNG ou WEBP');
            }
        }

        function createLot() {
            const nom = document.getElementById('lot-nom').value.trim();
            const prix = parseFloat(document.getElementById('lot-prix').value);
            const nbCartes = parseInt(document.getElementById('lot-nb-cartes').value) || 0;

            if (!nom || !prix) {
                alert('Veuillez renseigner au moins le nom et le prix du lot');
                return;
            }

            const dateInput = document.getElementById('lot-date').value;
            const dateAchat = dateInput ? new Date(dateInput).toISOString() : new Date().toISOString();

            const lot = {
                id: Date.now(),
                nom: nom,
                dateAchat: dateAchat,
                prix: prix,
                nbCartes: nbCartes,
                details: document.getElementById('lot-details').value,
                photo: currentLotPhoto,
                cartes: []
            };

            lots.push(lot);
            saveLots();
            updateLotSelect();
            renderLotsTable();
            closeCreateLotModal();
            alert('‚úÖ Lot cr√©√© avec succ√®s !');
        }

        function deleteLot(id) {
            if (confirm('Supprimer ce lot ? Les articles du stock associ√©s √† ce lot ne seront pas supprim√©s.')) {
                lots = lots.filter(l => l.id !== id);
                
                stockItems.forEach(item => {
                    if (item.lot == id) {
                        item.lot = '';
                    }
                });
                
                saveLots();
                saveStockItems();
                updateLotSelect();
                renderLotsTable();
            }
        }

        function updateLotSelect() {
            const select = document.getElementById('stock-lot');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Aucun lot</option>';
            lots.forEach(lot => {
                const option = document.createElement('option');
                option.value = lot.id;
                option.textContent = lot.nom;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }

        function renderLotsTable() {
            const tbody = document.getElementById('lots-table');
            tbody.innerHTML = '';

            lots.forEach((lot, idx) => {
                const photoHtml = lot.photo
                    ? `<img src="${lot.photo}" class="w-16 h-16 object-cover rounded cursor-pointer" onclick="zoomTablePhoto('${lot.photo}')" alt="Photo">`
                    : '<div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-gray-400">üì∑</div>';

                const dateFormatted = lot.dateAchat ? new Date(lot.dateAchat).toLocaleString('fr-FR') : '-';
                const rowClass = idx % 2 === 0 ? 'bg-gray-50' : 'bg-white';

                const nbCartesTotal = (lot.cartes || []).length;

                const row = `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3">${photoHtml}</td>
                        <td class="px-4 py-3 font-semibold">${lot.nom}</td>
                        <td class="px-4 py-3 text-sm">${dateFormatted}</td>
                        <td class="px-4 py-3 font-semibold">${lot.prix.toFixed(2)}‚Ç¨</td>
                        <td class="px-4 py-3 text-sm">${nbCartesTotal} carte(s)</td>
                        <td class="px-4 py-3 text-sm">${lot.details || '-'}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="openModifyLotModal(${lot.id})" class="text-purple-600 hover:text-purple-800 mr-2" title="Modifier le lot">‚öôÔ∏è</button>
                            <button onclick="deleteLot(${lot.id})" class="text-red-600 hover:text-red-800" title="Supprimer">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function openModifyLotModal(lotId) {
            currentEditingLotId = lotId;
            const lot = lots.find(l => l.id === lotId);
            if (!lot) return;

            document.getElementById('modify-lot-title').textContent = `Modifier le lot: ${lot.nom}`;
            document.getElementById('modify-lot-modal').style.display = 'flex';
            
            renderLotCardsList();
        }

        function closeModifyLotModal(event) {
            if (!event || event.target.id === 'modify-lot-modal') {
                document.getElementById('modify-lot-modal').style.display = 'none';
                currentEditingLotId = null;
                renderLotsTable();
            }
        }

        function renderLotCardsList() {
            const lot = lots.find(l => l.id === currentEditingLotId);
            if (!lot) return;

            const listDiv = document.getElementById('lot-cards-list');

            if (!lot.cartes || lot.cartes.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Aucune carte dans ce lot. Cliquez sur "Ajouter une carte au lot" pour commencer.</p>';
                return;
            }

            const prixAchatPotentiel = lot.prix / lot.cartes.length;

            listDiv.innerHTML = lot.cartes.map((carte, index) => {
                const photoHtml = carte.photo
                    ? `<img src="${carte.photo}" class="w-20 h-20 object-cover rounded cursor-pointer" onclick="zoomTablePhoto('${carte.photo}')" alt="Photo">`
                    : '<div class="w-20 h-20 bg-gray-200 rounded flex items-center justify-center text-xs">üì∑</div>';

                const typeColors = {
                    'Basique': 'bg-gray-100 text-gray-800',
                    'Reverse': 'bg-blue-100 text-blue-800',
                    'Holo': 'bg-purple-100 text-purple-800',
                    'Holo Reverse': 'bg-pink-100 text-pink-800'
                };

                const qualiteColors = {
                    'Mint': 'bg-green-100 text-green-800',
                    'Near Mint': 'bg-green-50 text-green-700',
                    'Excellent +': 'bg-blue-100 text-blue-800',
                    'Excellent': 'bg-blue-50 text-blue-700',
                    'Tr√®s bon': 'bg-yellow-100 text-yellow-800',
                    'Bon': 'bg-yellow-50 text-yellow-700',
                    'Played': 'bg-orange-100 text-orange-800',
                    'Mauvais': 'bg-red-100 text-red-800'
                };

                const prixReventeUnitaire = carte.prixRevente || 0;
                const prixReventeTotal = prixReventeUnitaire * (carte.quantite || 1);

                return `
                    <div class="bg-white border rounded p-4 flex gap-4 items-start">
                        ${photoHtml}
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="font-semibold text-lg">${carte.nom}</div>
                                ${carte.quantite > 1 ? `<span class="bg-purple-600 text-white text-xs px-2 py-1 rounded">√ó${carte.quantite}</span>` : ''}
                            </div>
                            <div class="flex gap-2 mb-2">
                                <span class="px-2 py-1 rounded text-xs font-semibold ${typeColors[carte.type] || 'bg-gray-100 text-gray-800'}">${carte.type}</span>
                                <span class="px-2 py-1 rounded text-xs font-semibold ${qualiteColors[carte.qualite] || 'bg-gray-100 text-gray-800'}">${carte.qualite}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <span class="text-gray-600">Prix d'achat potentiel:</span>
                                    <span class="font-semibold text-blue-600">${prixAchatPotentiel.toFixed(2)}‚Ç¨</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Prix de revente:</span>
                                    <span class="font-semibold text-green-600">
                                        ${prixReventeUnitaire > 0 ? `${prixReventeUnitaire.toFixed(2)}‚Ç¨/u` : '-'}
                                        ${carte.quantite > 1 && prixReventeUnitaire > 0 ? ` (Total: ${prixReventeTotal.toFixed(2)}‚Ç¨)` : ''}
                                    </span>
                                </div>
                            </div>
                            <div class="mt-2 text-sm">
                                <span class="text-gray-600">Description de l'√©tat:</span>
                                <p class="text-gray-800 mt-1">${carte.descriptionEtat || 'Non renseign√©'}</p>
                            </div>
                        </div>
                        <button onclick="removeCardFromLot(${index})" class="text-red-600 hover:text-red-800" title="Supprimer cette carte">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
        }

        function openAddCardToLotModal() {
            const lot = lots.find(l => l.id === currentEditingLotId);
            if (!lot) return;

            const prixAchatPotentiel = lot.prix / (lot.cartes.length + 1);
            document.getElementById('card-lot-prix-achat').value = prixAchatPotentiel.toFixed(2);

            document.getElementById('add-card-lot-modal').style.display = 'flex';
        }

        function closeAddCardToLotModal(event) {
            if (!event || event.target.id === 'add-card-lot-modal') {
                document.getElementById('add-card-lot-modal').style.display = 'none';
                document.getElementById('card-lot-nom').value = '';
                document.getElementById('card-lot-type').value = 'Basique';
                document.getElementById('card-lot-quantite').value = '1';
                document.getElementById('card-lot-qualite').value = 'Mint';
                document.getElementById('card-lot-prix-revente').value = '';
                document.getElementById('card-lot-description-etat').value = '';
                document.getElementById('card-lot-photo').value = '';
                document.getElementById('card-lot-photo-status').innerHTML = '';
                currentCardLotPhoto = null;
            }
        }

        function handleCardLotPhoto(event) {
            const file = event.target.files[0];
            if (file && ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    currentCardLotPhoto = reader.result;
                    document.getElementById('card-lot-photo-status').innerHTML = '<span class="text-green-600 text-sm">‚úì</span>';
                };
                reader.readAsDataURL(file);
            } else {
                alert('Format non support√©. Utilisez JPG, JPEG, PNG ou WEBP');
            }
        }

        function addCardToLot() {
            const nom = document.getElementById('card-lot-nom').value.trim();
            const type = document.getElementById('card-lot-type').value;
            const quantite = parseInt(document.getElementById('card-lot-quantite').value) || 1;
            const qualite = document.getElementById('card-lot-qualite').value;
            const prixRevente = parseFloat(document.getElementById('card-lot-prix-revente').value) || 0;
            const descriptionEtat = document.getElementById('card-lot-description-etat').value.trim();

            if (!nom) {
                alert('Veuillez au moins renseigner le nom de la carte');
                return;
            }

            const lot = lots.find(l => l.id === currentEditingLotId);
            if (!lot) return;

            if (!lot.cartes) {
                lot.cartes = [];
            }

            const carte = {
                nom: nom,
                type: type,
                quantite: quantite,
                qualite: qualite,
                photo: currentCardLotPhoto,
                prixRevente: prixRevente,
                descriptionEtat: descriptionEtat
            };

            lot.cartes.push(carte);
            saveLots();
            
            closeAddCardToLotModal();
            renderLotCardsList();
            renderLotsTable();
            
            alert('‚úÖ Carte ajout√©e au lot !');
        }

        function removeCardFromLot(index) {
            if (confirm('Supprimer cette carte du lot ?')) {
                const lot = lots.find(l => l.id === currentEditingLotId);
                if (!lot) return;

                lot.cartes.splice(index, 1);
                saveLots();
                renderLotCardsList();
                renderLotsTable();
            }
        }

        // === EXPORT/IMPORT ===

        function exportData() {
            const data = {
                collection: products,
                sales: saleProducts,
                stock: stockItems,
                lots: lots
            };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `pokemon-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('Donn√©es export√©es avec succ√®s ! üéâ');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (confirm(`Importer les donn√©es ?\n\nAttention : cela remplacera vos donn√©es actuelles.`)) {
                        products = importedData.collection || [];
                        saleProducts = importedData.sales || [];
                        stockItems = importedData.stock || [];
                        lots = importedData.lots || [];
                        saveProducts();
                        saveSaleProducts();
                        saveStockItems();
                        saveLots();
                        updateSummary();
                        filterProducts();
                        filterSaleProducts();
                        filterStockItems();
                        updateLotSelect();
                        renderLotsTable();
                        alert('Donn√©es import√©es avec succ√®s ! ‚úÖ');
                    }
                } catch (error) {
                    alert('Erreur lors de l\'importation. Fichier invalide.');
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // Init
        updateSummary();
        updateLotSelect();
        loadDarkMode();
        showTab('home');

        // === Dark Mode ===
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            // Mise √† jour de tous les boutons dark mode
            const icon = isDark ? '‚òÄÔ∏è' : 'üåô';
            const footerToggle = document.getElementById('footer-dark-toggle');
            if (footerToggle) footerToggle.textContent = icon;
        }

        function loadDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                const footerToggle = document.getElementById('footer-dark-toggle');
                if (footerToggle) footerToggle.textContent = '‚òÄÔ∏è';
            }
        }

        // Gestion du scroll des tableaux pour masquer l'indicateur
        function handleTableScroll(event) {
            if (event.target.scrollLeft > 50) {
                event.target.classList.add('scrolled');
            } else {
                event.target.classList.remove('scrolled');
            }
        }

        // === Menu burger mobile ===
        function toggleMobileNav() {
            const nav = document.getElementById('mobile-nav');
            const burger = document.querySelector('.burger-menu');
            
            nav.classList.toggle('active');
            burger.classList.toggle('active');
            
            // Emp√™cher le scroll du body quand le menu est ouvert
            if (nav.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        function closeMobileNavOnOverlay(event) {
            if (event.target.id === 'mobile-nav') {
                toggleMobileNav();
            }
        }

        function navigateMobile(tab) {
            showTab(tab);
            toggleMobileNav();
        }

        // === PWA Installation ===
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'flex';
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            installBtn.style.display = 'none';
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {
                console.log('Service Worker non disponible (normal en mode fichier local)');
            });
        }
    </script>
</body>
</html>
